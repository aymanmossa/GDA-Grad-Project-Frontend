<div class="container mx-auto py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 transition-colors">
            <h3 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">
                {{ isEditMode ? 'Edit Car' : 'Sell a Car' }}
            </h3>

            <form [formGroup]="carForm" (ngSubmit)="onSubmit()">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Release Year -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Release
                            Year <span class="text-red-500">*</span></label>
                        <input type="number"
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 ' + (isFieldInvalid('Year') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="Year" placeholder="e.g. 2023" />
                        @if (isFieldInvalid('Year')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('Year') }}
                        </p>
                        }
                    </div>

                    <!-- Price -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Price <span
                                class="text-red-500">*</span></label>
                        <input type="number"
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 ' + (isFieldInvalid('Price') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="Price" placeholder="e.g. 500000" />
                        @if (isFieldInvalid('Price')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('Price') }}
                        </p>
                        }
                    </div>

                    <!-- Mileage -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mileage
                            (km) <span class="text-red-500">*</span></label>
                        <input type="number"
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 ' + (isFieldInvalid('Mileage') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="Mileage" placeholder="e.g. 50000" />
                        @if (isFieldInvalid('Mileage')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('Mileage') }}
                        </p>
                        }
                    </div>

                    <!-- Inspection Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Inspection
                            Date <span class="text-red-500">*</span></label>
                        <input type="date"
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('LastInspectionDate') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="LastInspectionDate" />
                        @if (isFieldInvalid('LastInspectionDate')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('LastInspectionDate')
                            }}
                        </p>
                        }
                    </div>

                    <!-- Condition -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Condition <span
                                class="text-red-500">*</span></label>
                        <select
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('Condition') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="Condition">
                            <option [ngValue]="null">Select Condition</option>
                            <option [ngValue]="CarCondition.New">New</option>
                            <option [ngValue]="CarCondition.Used">Used</option>
                        </select>
                        @if (isFieldInvalid('Condition')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('Condition') }}
                        </p>
                        }
                    </div>

                    <!-- Transmission -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Transmission
                            <span class="text-red-500">*</span></label>
                        <select
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('GearType') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="GearType">
                            <option [ngValue]="null">Select Transmission type</option>
                            <option [ngValue]="CarGearType.Manual">Manual</option>
                            <option [ngValue]="CarGearType.Automatic">Automatic</option>
                        </select>
                        @if (isFieldInvalid('GearType')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('GearType') }}
                        </p>
                        }
                    </div>

                    <!-- Drivetrain -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Drivetrain <span
                                class="text-red-500">*</span></label>
                        <select
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('DrivetrainType') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="DrivetrainType">
                            <option [ngValue]="null">Select Drivetrain</option>
                            <option [ngValue]="DrivetrainType.FWD">FWD (Front Wheel Drive)</option>
                            <option [ngValue]="DrivetrainType.RWD">RWD (Rear Wheel Drive)</option>
                            <option [ngValue]="DrivetrainType.AWD">AWD (All Wheel Drive)</option>
                            <option [ngValue]="DrivetrainType.FourWD">4WD (Four Wheel Drive)</option>
                        </select>
                        @if (isFieldInvalid('DrivetrainType')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('DrivetrainType') }}
                        </p>
                        }
                    </div>

                    <!-- Engine Capacity -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Engine Capacity
                            (L) <span class="text-red-500">*</span></label>
                        <input type="number"
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 ' + (isFieldInvalid('EngineCapacity') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="EngineCapacity" placeholder="e.g. 2.0" />
                        @if (isFieldInvalid('EngineCapacity')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('EngineCapacity') }}
                        </p>
                        }
                    </div>

                    <!-- Horsepower -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Horsepower <span
                                class="text-red-500">*</span></label>
                        <input type="number"
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 ' + (isFieldInvalid('Horsepower') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="Horsepower" placeholder="e.g. 150" />
                        @if (isFieldInvalid('Horsepower')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('Horsepower') }}
                        </p>
                        }
                    </div>

                    <!-- Color -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color <span
                                class="text-red-500">*</span></label>
                        <input type="text"
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 ' + (isFieldInvalid('ExteriorColor') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="ExteriorColor" placeholder="e.g. White" />
                        @if (isFieldInvalid('ExteriorColor')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('ExteriorColor') }}
                        </p>
                        }
                    </div>

                    <!-- Brand -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Brand <span
                                class="text-red-500">*</span></label>
                        <select
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('MakeId') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="MakeId" (change)="onMakeChange()">
                            <option [ngValue]="null">Select brand</option>
                            @for (m of makes(); track m.makeId) {
                            <option [ngValue]="m.makeId">{{ m.makeName }}</option>
                            }
                        </select>
                        @if (isFieldInvalid('MakeId')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('MakeId') }}
                        </p>
                        }
                    </div>

                    <!-- Model -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model <span
                                class="text-red-500">*</span></label>
                        <select
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('ModelId') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="ModelId">
                            <option [ngValue]="null">Select model</option>
                            @for (mod of models(); track mod.modelId) {
                            <option [ngValue]="mod.modelId">{{ mod.modelName }}</option>
                            }
                        </select>
                        @if (isFieldInvalid('ModelId')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('ModelId') }}
                        </p>
                        }
                    </div>

                    <!-- Body Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Body Type <span
                                class="text-red-500">*</span></label>
                        <select
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('BodyTypeId') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="BodyTypeId">
                            <option [ngValue]="null">Select body type</option>
                            @for (b of bodyTypes(); track b.bodyTypeId) {
                            <option [ngValue]="b.bodyTypeId">{{ b.name }}</option>
                            }
                        </select>
                        @if (isFieldInvalid('BodyTypeId')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('BodyTypeId') }}
                        </p>
                        }
                    </div>

                    <!-- Fuel -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fuel <span
                                class="text-red-500">*</span></label>
                        <select
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('FuelId') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="FuelId">
                            <option [ngValue]="null">Select fuel</option>
                            @for (f of fuelTypes(); track f.fuelId) {
                            <option [ngValue]="f.fuelId">{{ f.name }}</option>
                            }
                        </select>
                        @if (isFieldInvalid('FuelId')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('FuelId') }}
                        </p>
                        }
                    </div>

                    <!-- Location -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location <span
                                class="text-red-500">*</span></label>
                        <select
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white ' + (isFieldInvalid('LocId') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            formControlName="LocId">
                            <option [ngValue]="null">Select location</option>
                            @for (l of locations(); track l.locId) {
                            <option [ngValue]="l.locId">{{ l.name }}</option>
                            }
                        </select>
                        @if (isFieldInvalid('LocId')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('LocId') }}
                        </p>
                        }
                    </div>

                    <!-- Description -->
                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description <span
                                class="text-red-500">*</span></label>
                        <textarea
                            [class]="'w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400 ' + (isFieldInvalid('Description') ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600')"
                            rows="3" formControlName="Description"
                            placeholder="Describe your car (at least 10 characters)"></textarea>
                        @if (isFieldInvalid('Description')) {
                        <p class="mt-1 text-sm text-red-500 dark:text-red-400">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i>{{ getErrorMessage('Description') }}
                        </p>
                        }
                    </div>

                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Images</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            @for (f of uploadedFiles; track $index; let i = $index) {
                            <div class="relative">
                                @if (getFileType(f.name) === 'image') {
                                <img [src]="f.previewUrl"
                                    class="w-20 h-20 object-cover rounded-lg border border-gray-300 dark:border-gray-600" />
                                }
                                <button type="button"
                                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 dark:hover:bg-red-700"
                                    (click)="removeFile(i)">Ã—</button>
                            </div>
                            }
                        </div>

                        <input type="file" accept="image/*" (change)="onFileSelected($event)"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900 dark:file:text-blue-200 dark:hover:file:bg-blue-800" />
                    </div>

                    <!-- Car License Upload (Required for Admin Approval) -->
                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fa-solid fa-file-contract mr-1 text-blue-600 dark:text-blue-400"></i>
                            Car License Document
                            <span class="text-red-500">*</span>
                        </label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                            <i class="fa-solid fa-info-circle mr-1"></i>
                            Upload your car's license document. This will be reviewed by admin before your listing is
                            approved.
                        </p>

                        <!-- Preview existing or new car license -->
                        @if (carLicensePreview || existingCarLicenseUrl) {
                        <div
                            class="mb-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-16 h-16 bg-white dark:bg-gray-700 rounded-lg overflow-hidden border border-gray-300 dark:border-gray-600 flex items-center justify-center">
                                        @if (carLicensePreview) {
                                        <img [src]="carLicensePreview" alt="Car License Preview"
                                            class="w-full h-full object-cover" />
                                        } @else if (existingCarLicenseUrl) {
                                        <img [src]="existingCarLicenseUrl" alt="Existing Car License"
                                            class="w-full h-full object-cover" />
                                        }
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                            @if (carLicenseFile) {
                                            {{ carLicenseFile.name }}
                                            } @else {
                                            Existing License Document
                                            }
                                        </p>
                                        <p class="text-xs text-green-600 dark:text-green-400">
                                            <i class="fa-solid fa-check-circle mr-1"></i>License uploaded
                                        </p>
                                    </div>
                                </div>
                                <button type="button" (click)="removeCarLicense()"
                                    class="px-3 py-1.5 text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                                    <i class="fa-solid fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                        }

                        <input type="file" accept="image/*,.pdf" (change)="onCarLicenseSelected($event)"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 dark:file:bg-green-900 dark:file:text-green-200 dark:hover:file:bg-green-800" />
                    </div>

                </div>

                <!-- Error Alert -->
                @if (errorMessage()) {
                <div class="mt-6 p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800 dark:text-red-300">
                                Error
                            </h3>
                            <div class="mt-2 text-sm text-red-700 dark:text-red-400 whitespace-pre-line">
                                {{ errorMessage() }}
                            </div>
                        </div>
                        <div class="ml-auto pl-3">
                            <button type="button" (click)="errorMessage.set(null)"
                                class="inline-flex rounded-md p-1.5 text-red-500 hover:bg-red-100 dark:hover:bg-red-800 focus:outline-none">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                }

                <div class="text-right mt-6">
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 text-white font-semibold py-2 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        [disabled]="isLoading || carForm.invalid">
                        {{ isEditMode ? 'Update' : 'Create' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>